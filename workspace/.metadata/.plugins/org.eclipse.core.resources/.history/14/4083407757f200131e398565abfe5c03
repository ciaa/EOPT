/*
 * ciaaUART.c
 *
 *  Created on: Jun 12, 2014
 *      Author: pablo
 */

void ciaaUARTInit(void)
{
	/* UART2 (USB-UART) */
	UART_CFG_Type cfg;

	cfg.Baud_rate = 115200;
	cfg.Clock_Speed = 0;
	cfg.Databits = UART_DATABIT_8;
	cfg.Parity = UART_PARITY_NONE;
	cfg.Stopbits = UART_STOPBIT_1;

	UART_Init(LPC_USART2, &cfg);
	UART_TxCmd(LPC_USART2, ENABLE);

	scu_pinmux(7, 1, MD_PDN, FUNC6); 					// P7_1: UART2_TXD
	scu_pinmux(7, 2, MD_PLN|MD_EZI|MD_ZI, FUNC6); 		// P7_2: UART2_RXD

	/* UART3 (RS232) */
	cfg.Baud_rate = 57600;
	UART_Init(LPC_USART3, &cfg);
	UART_TxCmd(LPC_USART3, ENABLE);

	scu_pinmux(2, 3, MD_PDN, FUNC2); 					// P2_3: UART3_TXD
	scu_pinmux(2, 4, MD_PLN|MD_EZI|MD_ZI, FUNC2); 		// P2_4: UART3_RXD

	UART_IntConfig((LPC_USARTn_Type *)LPC_USART3, UART_INTCFG_RBR, ENABLE);
	NVIC_EnableIRQ(USART3_IRQn);

}


void UART3_IRQHandler(void)
{
	if(UART_GetLineStatus(LPC_USART3)&UART_LINESTAT_RDR)
	{
		uartRxBuf[uartRxDataCount] = UART_ReceiveByte(LPC_USART3);
		uartRxDataCount++;
	}
	if(UART_GetLineStatus(LPC_USART3)&UART_LINESTAT_THRE)
	{
		UART_SendByte(LPC_USART3, *pTxOut);
		pTxOut++;
		if(pTxOut == (uartTxBuf + UART_BUF_SIZE))
			pTxOut = uartTxBuf;
	}
}

void uartSend(void * data, int datalen)
{
	int i;

	if(datalen==0) return;

	UART_SendByte(LPC_USART3, ((uint8_t *)data)[0]);

	for(i=1; i<datalen; i++)
	{
		*pTxIn = ((uint8_t*)data)[i];
		pTxIn++;
		if(pTxIn == (uartTxBuf + UART_BUF_SIZE))
			pTxIn = uartTxBuf;
	}
}
